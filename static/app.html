<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | LAW LINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            background-attachment: fixed;
            color: white;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Glassmorphism Classes */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .transition-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .transition-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="glass sticky top-0 z-50 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/app" class="flex items-center gap-3 hover:opacity-80 transition">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-pink-600 flex items-center justify-center shadow-lg shadow-orange-500/20">
                    <i class="fa-solid fa-scale-balanced text-white text-lg"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">LAW LINE</h1>
            </a>
            
            <div class="flex gap-6 items-center">
                <div id="userBadge" class="hidden md:flex items-center gap-2 text-xs font-medium text-slate-400 glass px-3 py-1 rounded-full">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span id="usernameDisplay">System Online</span>
                </div>

                <div class="flex items-center gap-4">
                    <a href="/about" class="text-sm font-medium text-slate-400 hover:text-white transition">About</a>
                    
                    <select id="langSelect" class="glass text-xs text-white px-3 py-1 rounded-lg outline-none focus:border-orange-500 transition cursor-pointer bg-transparent">
                        <option value="English" class="bg-slate-900">ðŸ‡¬ðŸ‡§ EN</option>
                        <option value="Hindi" class="bg-slate-900">ðŸ‡®ðŸ‡³ HI</option>
                        <option value="Tamil" class="bg-slate-900">ðŸ‡®ðŸ‡³ TA</option>
                        <option value="Telugu" class="bg-slate-900">ðŸ‡®ðŸ‡³ TE</option>
                    </select>

                    <div class="h-6 w-px bg-white/20"></div> <button onclick="logout()" class="text-sm flex items-center gap-2 text-red-400 hover:text-red-300 transition" title="Logout">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto p-6 w-full grid grid-cols-1 lg:grid-cols-12 gap-8 mt-4">
        
        <div class="lg:col-span-5 space-y-6 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="glass p-8 rounded-3xl relative overflow-hidden group">
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-blue-500/20 rounded-full blur-3xl group-hover:bg-blue-500/30 transition-all duration-700"></div>

                <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">
                    <i class="fa-regular fa-comment-dots text-orange-400"></i> 
                    Describe Your Situation
                </h2>
                
                <textarea id="userInput" rows="6" 
                    class="w-full p-5 bg-black/20 border border-white/10 rounded-2xl focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 outline-none resize-none transition-all text-slate-200 placeholder-slate-500"
                    placeholder="Example: My employer fired me without notice and is refusing to pay my last month's salary..."></textarea>
                
                <button onclick="analyzeLaw()" 
                    class="w-full mt-6 bg-gradient-to-r from-orange-600 to-pink-600 hover:from-orange-500 hover:to-pink-500 text-white py-4 rounded-xl font-bold shadow-xl shadow-orange-900/20 transition-all transform hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-3">
                    <span>Analyze & Draft Legal Notice</span>
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
                <p id="errorMsg" class="text-red-400 text-sm mt-4 text-center hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass p-4 rounded-2xl flex flex-col items-center text-center transition-card">
                    <i class="fa-solid fa-robot text-blue-400 text-2xl mb-2"></i>
                    <h4 class="font-bold text-sm">AI Analysis</h4>
                    <p class="text-xs text-slate-400 mt-1">Instant Case Mapping</p>
                </div>
                <div class="glass p-4 rounded-2xl flex flex-col items-center text-center transition-card">
                    <i class="fa-solid fa-file-pen text-green-400 text-2xl mb-2"></i>
                    <h4 class="font-bold text-sm">Auto-Drafting</h4>
                    <p class="text-xs text-slate-400 mt-1">Ready-to-Print Docs</p>
                </div>
            </div>
        </div>

        <div id="resultSection" class="lg:col-span-7 hidden space-y-6 animate-fade-in" style="animation-delay: 0.2s;">
            
            <div class="glass rounded-3xl overflow-hidden shadow-2xl transition-card">
                <div class="h-48 w-full overflow-hidden relative">
                    <img id="resImage" src="" alt="Legal Context" class="w-full h-full object-cover opacity-80 hover:scale-105 transition-transform duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 p-6">
                        <span id="resAct" class="bg-orange-500/90 text-white text-xs font-bold px-3 py-1 rounded-full backdrop-blur-sm shadow-lg mb-2 inline-block">Section Loading...</span>
                        <h2 id="resTitle" class="text-3xl font-bold text-white leading-tight shadow-black drop-shadow-lg">Case Title</h2>
                    </div>
                </div>
                
                <div class="px-6 py-3 bg-white/5 border-b border-white/5 flex justify-between items-center">
                    <span class="text-xs text-slate-400 font-mono uppercase tracking-widest">AI Legal Advisory</span>
                    <button onclick="toggleAudio()" class="text-sm flex items-center gap-2 text-blue-400 hover:text-blue-300 transition group">
                        <i id="audioIcon" class="fa-solid fa-circle-play text-lg group-hover:scale-110 transition-transform"></i>
                        <span id="audioText">Listen to Advice</span>
                    </button>
                </div>

                <div class="p-8">
                    <h3 class="font-semibold text-lg text-orange-200 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-list-check"></i> Action Plan
                    </h3>
                    <div id="resSteps" class="space-y-4 text-slate-300 leading-relaxed">
                        </div>
                </div>
            </div>

            <div class="glass-panel p-1 rounded-3xl shadow-2xl border border-orange-500/30 relative">
                <div class="absolute top-4 right-6 z-10">
                    <button onclick="copyDraft()" class="bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-2 rounded-lg backdrop-blur-md border border-white/10 transition flex items-center gap-2">
                        <i class="fa-regular fa-copy"></i> Copy
                    </button>
                </div>
                <div class="bg-slate-950/50 rounded-[20px] p-6 pt-12 overflow-hidden">
                     <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 absolute top-6 left-6">
                        <i class="fa-solid fa-file-contract mr-2"></i> Official Legal Notice Draft
                    </h3>
                    <pre id="resDraft" class="mono text-xs text-slate-300 whitespace-pre-wrap leading-6 h-64 overflow-y-auto custom-scrollbar pr-2">
                        Generating legal notice...
                    </pre>
                </div>
            </div>

        </div>
    </main>

    <div id="loader" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden flex flex-col items-center justify-center z-[100]">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-orange-500/30 border-t-orange-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa-solid fa-gavel text-orange-500 text-lg animate-pulse"></i>
            </div>
        </div>
        <p class="text-white font-medium mt-4 tracking-wide animate-pulse">Consulting the Constitution...</p>
    </div>

    <script>
        // 1. SECURITY & SESSION CHECK
        const userType = localStorage.getItem('userType');
        
        if (!userType) {
            // Kick back to login if no session found
            window.location.href = '/'; 
        } else {
            // Update UI for User
            const display = document.getElementById('usernameDisplay');
            if(userType === 'guest') display.innerText = "Guest Mode";
            else display.innerText = "Administrator";
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // 2. MAIN APP LOGIC
        let currentExplanation = "";

        async function analyzeLaw() {
            const input = document.getElementById('userInput').value;
            const lang = document.getElementById('langSelect').value;
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('resultSection');
            const errorMsg = document.getElementById('errorMsg');

            if(!input) return;

            // Reset UI
            loader.classList.remove('hidden');
            resultSection.classList.add('hidden');
            errorMsg.classList.add('hidden');
            window.speechSynthesis.cancel(); // Stop audio

            try {
                // Call the Backend API
                // Note: using relative path '/analyze' works because main.py serves both static & api
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: input, language: lang })
                });
                
                const data = await response.json();

                if(data.status === "success") {
                    // Populate Text Data
                    document.getElementById('resTitle').innerText = data.category;
                    document.getElementById('resAct').innerText = data.act;
                    document.getElementById('resSteps').innerHTML = formatSteps(data.simple_explanation);
                    document.getElementById('resDraft').innerText = data.draft_letter;
                    
                    // Dynamic Image Generation (Based on category name)
                    const seed = data.category.replace(/\s+/g, '-').toLowerCase(); 
                    document.getElementById('resImage').src = `https://picsum.photos/seed/${seed}/800/400?grayscale&blur=2`;
                    
                    // Store text for Audio Player
                    currentExplanation = data.simple_explanation.replace(/\*/g, '');

                    // Reveal Result
                    resultSection.classList.remove('hidden');
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    errorMsg.innerText = data.message;
                    errorMsg.classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                errorMsg.innerText = "Server Connection Failed. Is main.py running?";
                errorMsg.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // 3. HELPER FUNCTIONS
        function formatSteps(text) {
            // Converts plain text/markdown list into pretty HTML cards
            return text.replace(/\*/g, '').split('\n').map(line => 
                line.trim().length > 0 ? 
                `<div class="flex gap-4 group p-2 hover:bg-white/5 rounded-lg transition">
                    <div class="min-w-[4px] bg-orange-500 rounded-full h-auto opacity-70 group-hover:opacity-100 transition"></div>
                    <p class="text-sm">${line}</p>
                </div>` : ''
            ).join('');
        }

        function copyDraft() {
            const text = document.getElementById('resDraft').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('button[onclick="copyDraft()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            setTimeout(() => btn.innerHTML = originalHTML, 2000);
        }

        // 4. AUDIO LOGIC
        let isSpeaking = false;
        
        function toggleAudio() {
            const icon = document.getElementById('audioIcon');
            const text = document.getElementById('audioText');

            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                icon.classList.replace('fa-circle-pause', 'fa-circle-play');
                text.innerText = "Listen to Advice";
            } else {
                if (!currentExplanation) return;
                
                const utterance = new SpeechSynthesisUtterance(currentExplanation);
                const lang = document.getElementById('langSelect').value;
                
                // Voice localization attempts
                if(lang === "Hindi") utterance.lang = 'hi-IN';
                else utterance.lang = 'en-IN'; 
                
                utterance.rate = 0.9; 

                utterance.onend = () => {
                    isSpeaking = false;
                    icon.classList.replace('fa-circle-pause', 'fa-circle-play');
                    text.innerText = "Listen to Advice";
                };

                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                icon.classList.replace('fa-circle-play', 'fa-circle-pause');
                text.innerText = "Stop Audio";
            }
        }
    </script>
</body>
</html>